# 手動執行標準作業程序 (SOP)

本文件說明如何透過手動方式，一步步執行聯邦學習實驗。此方法提供最高的控制權，便於偵錯與詳細觀察。

## 1. 產生標準作業程序 (SOP) 腳本

首先，使用 `orchestrate.sh` 腳本並加上 `--manual` 旗標，即可產生一個包含實驗所需所有指令的 Shell 腳本。建議將輸出重新導向到一個檔案，例如 `sop.sh`。

### 基本語法
```bash
./src/orchestrate.sh <DATASET_NAME> <CLIENT_NUM> <TOTAL_ROUNDS> --manual > sop.sh
```

### 參數說明
- `DATASET_NAME`: 資料集名稱 (例如：kitti, cityscapes)
- `CLIENT_NUM`: 客戶端數量 (例如：4)
- `TOTAL_ROUNDS`: 聯邦學習輪次 (例如：2, 5)
- `--manual`: **必要旗標**，用以生成手動執行的 SOP。
- `--val`: 可選旗標，若加入，則產生的 SOP 中會包含模型驗證的步驟。

### 範例
```bash
# 產生一個 kitti 資料集、4 個客戶端、2 輪學習的 SOP
./src/orchestrate.sh kitti 4 2 --manual > sop.sh

# 產生一個 cityscapes 資料集、8 個客戶端、3 輪學習的 SOP，並包含驗證步驟
./src/orchestrate.sh cityscapes 8 3 --manual --val > cityscapes_sop.sh
```

## 2. 檢視並執行 SOP 腳本

使用文字編輯器打開您剛剛產生的 `sop.sh` 檔案。您會看到所有指令都已經按照步驟和輪次整理好。

建議逐行或逐區塊複製到您的終端機中執行，以便在進入下一步前，檢查每一步的輸出結果。

### 偵錯提示
若要偵錯，您可以使用 `bash -x` 來執行 SOP 腳本，這將會顯示每個指令的詳細執行過程：
```bash
bash -x sop.sh
```

## 3. 手動執行流程概覽

一個典型的 SOP 流程包含以下步驟：

1.  **設定環境變數**: 匯出後續指令所需的環境變數。
2.  **資料準備**: 執行 `data_prepare.py` 來分割資料集。
3.  **建立實驗目錄**: 為本次實驗建立所需的輸出檔案夾。
4.  **第一輪：客戶端訓練**: 提交所有客戶端的訓練任務。
5.  **第一輪：聯邦平均**: 等待所有客戶端訓練完成後，執行權重聚合。
6.  ... (重複執行客戶端訓練與聯邦平均，直到所有輪次結束) ...
7.  **(可選) 模型驗證**: 若您在產生 SOP 時加入了 `--val` 旗標，最後會有驗證模型的步驟。

遵循此程序，您便能精準地控制整個聯邦學習流程。
